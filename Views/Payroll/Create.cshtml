@model HR_Products.ViewModels.PayrollCreateViewModel

@{
    ViewData["Title"] = "Create Payroll (Monthly)";
}

<h4>Create Payroll Record</h4>
<hr />

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="All" class="text-danger"></div>

    <div class="row">
        @if (Model.IsAdmin)
        {
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="EmpeId" class="control-label">Employee</label>
                    <select asp-for="EmpeId" class="form-control" asp-items="Model.Employees" id="EmpeIdSelect">
                        <option value="">Select Employee</option>
                    </select>
                    <span asp-validation-for="EmpeId" class="text-danger"></span>
                </div>
            </div>
        }
        else
        {
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Employee</label>
                    <input class="form-control" value="@Model.EmpeName" readonly />
                    <input type="hidden" asp-for="EmpeId" id="EmpeIdHidden" />
                </div>
            </div>
        }

    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Department" class="control-label"></label>
                <input asp-for="Department" class="form-control" id="DepartmentInput" readonly />
                <span asp-validation-for="Department" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Position" class="control-label"></label>
                <input asp-for="Position" class="form-control" id="PositionInput" readonly />
                <span asp-validation-for="Position" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="BasicSalary" class="control-label"></label>
                <input asp-for="BasicSalary" class="form-control" id="BasicSalaryInput" type="number" step="0.01" value="@Model.BasicSalary.ToString("0.00")" />
                <span asp-validation-for="BasicSalary" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Allowance" class="control-label"></label>
                <input asp-for="Allowance" class="form-control" id="AllowanceInput" type="number" step="0.01" value="@Model.Allowance.ToString("0.00")" />
                <span asp-validation-for="Allowance" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="OvertimeHours" class="control-label"></label>
                <input asp-for="OvertimeHours" class="form-control" id="OvertimeHoursInput" type="number" step="0.01" value="@Model.OvertimeHours.ToString("0.00")" />
                <span asp-validation-for="OvertimeHours" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Tax" class="control-label"></label>
                <input asp-for="Tax" class="form-control" id="TaxInput" type="number" step="0.01" value="@Model.Tax.ToString("0.00")" />
                <span asp-validation-for="Tax" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Deductions" class="control-label"></label>
                <input asp-for="Deductions" class="form-control" id="DeductionsInput" type="number" step="0.01" value="@Model.Deductions.ToString("0.00")" />
                <span asp-validation-for="Deductions" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="GrossPay" class="control-label"></label>
                <input asp-for="GrossPay" class="form-control" id="GrossPayInput" type="number" step="0.01" readonly value="@Model.GrossPay.ToString("0.00")" />
                <span asp-validation-for="GrossPay" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="NetPay" class="control-label"></label>
                <input asp-for="NetPay" class="form-control" id="NetPayInput" readonly value="@Model.NetPay.ToString("0.00")" />
                <span asp-validation-for="NetPay" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="PayDate" class="control-label"></label>
                <input asp-for="PayDate" class="form-control" type="date" />
                <span asp-validation-for="PayDate" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="FrDate" class="control-label"></label>
                <input asp-for="FrDate" class="form-control" type="date" id="FrDateInput" />
                <span asp-validation-for="FrDate" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="ToDate" class="control-label"></label>
                <input asp-for="ToDate" class="form-control" type="date" id="ToDateInput" />
                <span asp-validation-for="ToDate" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="form-group mt-3">
        <a class="btn btn-outline-warning btn-md" style="width: 100px;" href="javascript:history.back()" role="button">Back</a>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const empeIdSelect = document.getElementById("EmpeIdSelect");
            const empeIdHidden = document.getElementById("EmpeIdHidden");
            const departmentInput = document.getElementById("DepartmentInput");
            const positionInput = document.getElementById("PositionInput");

            const basicSalaryInput = document.getElementById("BasicSalaryInput");
            const allowanceInput = document.getElementById("AllowanceInput");
            const taxInput = document.getElementById("TaxInput");
            const deductionsInput = document.getElementById("DeductionsInput");
            const netPayInput = document.getElementById("NetPayInput");

            const frDateInput = document.getElementById("FrDateInput");
            const toDateInput = document.getElementById("ToDateInput");


            async function populateEmployeeDetails(employeeId) {
                if (!employeeId || parseInt(employeeId) <= 0) {
                    departmentInput.value = '';
                    positionInput.value = '';
                    basicSalaryInput.value = (0).toFixed(2);
                    console.log("No valid Employee ID for auto-population.");
                    calculateNetPayWithDeductions(); 
                    return;
                }

                console.log("Fetching details for EmpeId:", employeeId);

                try {
                    const response = await fetch(`/Payroll/GetEmployeeDetails?employeeId=${employeeId}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Server responded with status ${response.status}: ${errorData.error || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    departmentInput.value = data.department || '';
                    positionInput.value = data.position || '';
                    basicSalaryInput.value = parseFloat(data.basicSalary || 0).toFixed(2);
                    console.log("Successfully populated fields:", data);

                    calculateNetPayWithDeductions();

                } catch (error) {
                    console.error("Error fetching employee details:", error);
                    departmentInput.value = '';
                    positionInput.value = '';
                    basicSalaryInput.value = (0).toFixed(2);
                    alert("Could not load employee details. Please try again or check the selected employee. Error: " + error.message);
                    calculateNetPayWithDeductions(); 
                }
            }

            async function calculateNetPayWithDeductions() {
                const employeeId = empeIdSelect ? empeIdSelect.value : empeIdHidden.value;
                const basicSalary = parseFloat(basicSalaryInput.value) || 0;
                const allowance = parseFloat(allowanceInput.value) || 0;
                const tax = parseFloat(taxInput.value) || 0;
                const deductions = parseFloat(deductionsInput.value) || 0;
                const frDate = frDateInput.value;
                const toDate = toDateInput.value;

                if (!employeeId || parseInt(employeeId) <= 0 || !frDate || !toDate) {
                    netPayInput.value = (basicSalary + allowance - tax - deductions).toFixed(2);
                    return;
                }

                console.log("Calculating NetPay with deductions via AJAX...", { employeeId, basicSalary, allowance, tax, deductions, frDate, toDate });

                try {
                    const params = new URLSearchParams({
                        employeeId: employeeId,
                        basicSalary: basicSalary,
                        allowance: allowance,
                        tax: tax,
                        overtimeHours: parseFloat(document.getElementById("OvertimeHoursInput").value) || 0,
                        deductions: deductions,
                        frDate: frDate,
                        toDate: toDate
                    });
                    const response = await fetch(`/Payroll/GetCalculatedNetPay?${params.toString()}`);

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Server responded with status ${response.status}: ${errorData.error || 'Unknown calculation error'}`);
                    }
                    const data = await response.json();
                    netPayInput.value = parseFloat(data.netPay).toFixed(2);
                    console.log("NetPay calculated:", data.netPay);
                } catch (error) {
                    console.error("Error calculating NetPay with leave deductions:", error);
                    netPayInput.value = (basicSalary + allowance - tax - deductions).toFixed(2);
                    alert("Could not calculate NetPay with leave deductions. Using basic calculation. Error: " + error.message);
                }
            }

            if (empeIdSelect) {
                empeIdSelect.addEventListener('change', function() {
                    populateEmployeeDetails(this.value);
                });
            }

            const initialEmpeId = empeIdSelect ? empeIdSelect.value : empeIdHidden.value;
            if (initialEmpeId) {
                populateEmployeeDetails(initialEmpeId);
            } else {
                calculateNetPayWithDeductions();
            }

            if (basicSalaryInput) basicSalaryInput.addEventListener('input', calculateNetPayWithDeductions);
            if (allowanceInput) allowanceInput.addEventListener('input', calculateNetPayWithDeductions);
            if (taxInput) taxInput.addEventListener('input', calculateNetPayWithDeductions);
            if (deductionsInput) deductionsInput.addEventListener('input', calculateNetPayWithDeductions);

            if (frDateInput) frDateInput.addEventListener('change', calculateNetPayWithDeductions);
            if (toDateInput) toDateInput.addEventListener('change', calculateNetPayWithDeductions);

            const overtimeHoursInput = document.getElementById("OvertimeHoursInput");
            const grossPayInput = document.getElementById("GrossPayInput");

            if (basicSalaryInput && allowanceInput && overtimeHoursInput && grossPayInput) {
                function calculateGrossPay() {
                    const basicSalary = parseFloat(basicSalaryInput.value) || 0;
                    const allowance = parseFloat(allowanceInput.value) || 0;
                    const overtimeHours = parseFloat(overtimeHoursInput.value) || 0;
                    grossPayInput.value = (basicSalary + allowance + overtimeHours).toFixed(2);
                }
                basicSalaryInput.addEventListener('input', calculateGrossPay);
                allowanceInput.addEventListener('input', calculateGrossPay);
                overtimeHoursInput.addEventListener('input', calculateGrossPay);
                calculateGrossPay(); 
            }
        });
    </script>
}